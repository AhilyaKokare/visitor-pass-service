<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="mb-1">User Management</h3>
      <p class="text-muted mb-0">Manage users and their roles in your organization</p>
    </div>
    <!-- Enhanced Create User Button -->
    <button
      type="button"
      class="btn btn-primary btn-lg btn-modern"
      data-bs-toggle="modal"
      data-bs-target="#createUserModal"
      (click)="resetForm()"
      title="Create a new user account">
      <i class="bi bi-person-plus-fill me-2"></i>Create New User
    </button>
  </div>

  <div *ngIf="isLoading; else userTable">
    <app-loading-spinner></app-loading-spinner>
  </div>

  <ng-template #userTable>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Department</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of userPage?.content">
            <td>{{ user.name }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.role.replace('ROLE_', '') | titlecase }}</td>
            <td>{{ user.department }}</td>
            <td>
              <span class="badge" [ngClass]="user.isActive ? 'bg-success' : 'bg-secondary'">
                {{ user.isActive ? 'Active' : 'Inactive' }}
              </span>
            </td>
            <td>
              <button class="btn btn-sm" [ngClass]="user.isActive ? 'btn-warning' : 'btn-success'" (click)="toggleUserStatus(user)">
                {{ user.isActive ? 'Deactivate' : 'Activate' }}
              </button>
            </td>
          </tr>
          <tr *ngIf="!isLoading && userPage?.empty">
            <td colspan="6" class="text-center">No users found for this location. Click "Create New User" to begin.</td>
          </tr>
        </tbody>
      </table>
    </div>
    <app-pagination [page]="userPage" (pageChange)="onPageChange($event)"></app-pagination>
  </ng-template>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="createUserModalLabel">
          <i class="bi bi-person-plus-fill me-2"></i>Create New User
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" #closeModalButton></button>
      </div>
      <div class="modal-body">
        <form #userForm="ngForm" novalidate>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Full Name *</label>
              <input
                type="text"
                class="form-control"
                name="name"
                [(ngModel)]="newUser.name"
                #nameInput="ngModel"
                required
                placeholder="Enter full name">
              <div *ngIf="nameInput.invalid && (nameInput.dirty || nameInput.touched)" class="text-danger small">
                Full name is required.
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">Email Address *</label>
              <input
                type="email"
                class="form-control"
                name="email"
                [(ngModel)]="newUser.email"
                #emailInput="ngModel"
                required
                email
                placeholder="user@company.com">
              <div *ngIf="emailInput.invalid && (emailInput.dirty || emailInput.touched)" class="text-danger small">
                <div *ngIf="emailInput.errors?.['required']">Email address is required.</div>
                <div *ngIf="emailInput.errors?.['email']">Please enter a valid email address.</div>
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">Password *</label>
              <div class="input-group">
                <input
                  [type]="showPassword ? 'text' : 'password'"
                  class="form-control"
                  name="password"
                  [(ngModel)]="newUser.password"
                  #passwordInput="ngModel"
                  required
                  minlength="8"
                  placeholder="Minimum 8 characters">
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  (click)="togglePasswordVisibility()">
                  <i class="bi" [class.bi-eye]="!showPassword" [class.bi-eye-slash]="showPassword"></i>
                </button>
              </div>
              <div *ngIf="passwordInput.invalid && (passwordInput.dirty || passwordInput.touched)" class="text-danger small">
                <div *ngIf="passwordInput.errors?.['required']">Password is required.</div>
                <div *ngIf="passwordInput.errors?.['minlength']">Password must be at least 8 characters long.</div>
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">Role *</label>
              <select
                class="form-select"
                name="role"
                [(ngModel)]="newUser.role"
                #roleInput="ngModel"
                required>
                <option value="">Select a role</option>
                <option value="ROLE_EMPLOYEE">Employee</option>
                <option value="ROLE_APPROVER">Approver</option>
                <option value="ROLE_SECURITY">Security</option>
              </select>
              <div *ngIf="roleInput.invalid && (roleInput.dirty || roleInput.touched)" class="text-danger small">
                Please select a role.
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">Department</label>
              <input
                type="text"
                class="form-control"
                name="department"
                [(ngModel)]="newUser.department"
                placeholder="e.g., IT, HR, Finance">
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">Joining Date *</label>
              <input
                type="date"
                class="form-control"
                name="joiningDate"
                [(ngModel)]="newUser.joiningDate"
                #joiningDateInput="ngModel"
                required>
              <div *ngIf="joiningDateInput.invalid && (joiningDateInput.dirty || joiningDateInput.touched)" class="text-danger small">
                Joining date is required.
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">Gender</label>
              <select class="form-select" name="gender" [(ngModel)]="newUser.gender">
                <option value="">Select gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
                <option value="Prefer not to say">Prefer not to say</option>
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">Contact Number</label>
              <input
                type="tel"
                class="form-control"
                name="contact"
                [(ngModel)]="newUser.contact"
                placeholder="+1 (555) 123-4567">
            </div>

            <div class="col-12 mb-3">
              <label class="form-label">Address</label>
              <textarea
                class="form-control"
                name="address"
                [(ngModel)]="newUser.address"
                rows="3"
                placeholder="Enter full address"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button
          type="button"
          class="btn btn-primary"
          [disabled]="!userForm.valid || isSubmitting"
          (click)="onCreateUser()">
          <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
          {{ isSubmitting ? 'Creating...' : 'Create User' }}
        </button>
      </div>
    </div>
  </div>
</div>
