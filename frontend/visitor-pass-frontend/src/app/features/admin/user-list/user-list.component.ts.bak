import { Component, OnInit, ViewChild, ElementRef } from '@angular/core';
import { CommonModule, TitleCasePipe } from '@angular/common';
import { RouterModule } from '@angular/router';
import { FormsModule } from '@angular/forms';
import { ToastrService } from 'ngx-toastr';
import { UserService } from '../../../core/services/user.service';
import { AuthService } from '../../../core/services/auth.service';
import { User } from '../../../core/models/user.model';
import { LoadingSpinnerComponent } from '../../../shared/loading-spinner/loading-spinner.component';
import { ConfirmationService } from '../../../core/services/confirmation.service';
import { Page, PaginationComponent } from '../../../shared/pagination/pagination.component';

@Component({
  selector: 'app-user-list',
  standalone: true,
  imports: [CommonModule, RouterModule, TitleCasePipe, LoadingSpinnerComponent, FormsModule, PaginationComponent],
  templateUrl: './user-list.component.html',
})
export class UserListComponent implements OnInit {
  @ViewChild('closeModalButton') closeModalButton!: ElementRef;

  // User list properties
  userPage: Page<User> | null = null;
  tenantId!: number;
  isLoading = true;
  currentPage = 0;
  pageSize = 10;

  // Create user form properties
  showCreateForm = false;
  isSubmitting = false;
  showPassword = false;

  // New user object for form binding
  newUser = {
    name: '',
    email: '',
    password: '',
    role: '',
    department: '',
    joiningDate: ''
  };

  constructor(
    private userService: UserService,
    private authService: AuthService,
    private toastr: ToastrService,
    private confirmationService: ConfirmationService
  ) {}

  ngOnInit(): void {
    const user = this.authService.getDecodedToken();
    if (user && user.tenantId) {
      this.tenantId = user.tenantId;
      this.loadUsers();
    } else {
      this.toastr.error('Unable to load user information. Please login again.', 'Authentication Error');
    }
  }

  // Load users with pagination
  loadUsers(): void {
    this.isLoading = true;
    this.userService.getUsers(this.tenantId, this.currentPage, this.pageSize).subscribe({
      next: (response) => {
        this.userPage = response;
        this.isLoading = false;
        console.log('Users loaded:', response);
      },
      error: (err) => {
        console.error('Error loading users:', err);
        this.toastr.error('Failed to load users');
        this.isLoading = false;
      }
    });
  }

  // Page change handler
  onPageChange(pageNumber: number): void {
    this.currentPage = pageNumber;
    this.loadUsers();
  }

  // Statistics methods
  getActiveUsersCount(): number {
    return this.userPage?.content?.filter(user => user.isActive).length || 0;
  }

  getInactiveUsersCount(): number {
    return this.userPage?.content?.filter(user => !user.isActive).length || 0;
  }

  // Page size management
  changePageSize(newSize: number): void {
    this.pageSize = newSize;
    this.currentPage = 0; // Reset to first page
    this.loadUsers();
  }

  // Role badge styling
  getRoleBadgeClass(role: string): string {
    switch (role) {
      case 'ROLE_TENANT_ADMIN':
        return 'bg-danger';
      case 'ROLE_APPROVER':
        return 'bg-warning text-dark';
      case 'ROLE_SECURITY':
        return 'bg-info';
      case 'ROLE_EMPLOYEE':
        return 'bg-primary';
      default:
        return 'bg-secondary';
    }
  }

  // Form management methods
  toggleCreateForm(): void {
    this.showCreateForm = !this.showCreateForm;
    if (this.showCreateForm) {
      this.clearForm();
    }
  }

  cancelCreateForm(): void {
    this.showCreateForm = false;
    this.clearForm();
  }

  clearForm(): void {
    this.newUser = {
      name: '',
      email: '',
      password: '',
      role: '',
      department: '',
      joiningDate: ''
    };
    this.showPassword = false;
    this.isSubmitting = false;
  }

  togglePasswordVisibility(): void {
    this.showPassword = !this.showPassword;
  }

  // Create user method
  createUser(): void {
    console.log('=== CREATE USER ===');

    // Check if user has permission
    const currentUser = this.authService.getDecodedToken();
    if (!currentUser || currentUser.role !== 'ROLE_TENANT_ADMIN') {
      this.toastr.error('You do not have permission to create users.', 'Permission Denied');
      return;
    }

    // Validation
    if (!this.newUser.name || !this.newUser.email || !this.newUser.password || !this.newUser.role || !this.newUser.joiningDate) {
      this.toastr.warning('Please fill in all required fields', 'Missing Fields');
      return;
    }

    console.log('Creating user:', this.newUser);
    this.isSubmitting = true;

    this.userService.createUser(this.tenantId, this.newUser).subscribe({
      next: (response) => {
        console.log('User created successfully:', response);
        this.toastr.success(`User "${this.newUser.name}" created successfully!`, 'Success');
        this.loadUsers();
        this.showCreateForm = false;
        this.clearForm();
      },
      error: (err) => {
        console.error('Error creating user:', err);
        this.isSubmitting = false;

        // Handle different error scenarios
        if (err.status === 401) {
          this.toastr.error('Session expired. Please login again.', 'Authentication Error');
        } else if (err.status === 403) {
          this.toastr.error('You do not have permission to create users.', 'Permission Denied');
        } else if (err.status === 400) {
          this.toastr.error(err.error?.message || 'Invalid user data provided.', 'Validation Error');
        } else if (err.status === 409) {
          this.toastr.error('A user with this email already exists.', 'Duplicate User');
        } else {
          this.toastr.error(err.error?.message || 'Failed to create user. Please try again.', 'Error');
        }
      }
    });
  }

  // Toggle user status method
  toggleUserStatus(user: User): void {
    const action = user.isActive ? 'deactivate' : 'activate';
    const confirmed = this.confirmationService.confirm(`Are you sure you want to ${action} ${user.name}?`);

    if (confirmed) {
      this.userService.updateUserStatus(this.tenantId, user.id, !user.isActive).subscribe({
        next: () => {
          this.toastr.success(`User ${action}d successfully!`);
          this.loadUsers();
        },
        error: () => {
          this.toastr.error(`Failed to ${action} user.`);
        }
      });
    }
  }
}
